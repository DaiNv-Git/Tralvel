name: TravelStride CI/CD

on:
  push:
    branches: [ main, dev,product ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into VPS, pull code, build and restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "== SSH into VPS and Pull latest code =="
            cd ~/Travel/BE/Tralvel

            echo "== Pull latest code =="
            git pull origin product

            echo "== Build new JAR =="
            mvn clean package -U -DskipTests

            echo "== Backup old JAR =="
            mkdir -p backup
            if [ -f target/travel-app-0.0.1-SNAPSHOT.jar ]; then
              cp target/travel-app-0.0.1-SNAPSHOT.jar backup/travel-app-$(date +"%Y%m%d%H%M%S").jar
            fi

            echo "== Restart travel-app using PM2 =="
            pm2 stop travel-app || true
            pm2 delete travel-app || true
            pm2 start target/travel-app-0.0.1-SNAPSHOT.jar --name travel-app -- --server.port=3082

      - name: Notify Telegram Success
        run: |
          deploy_time=$(date +"%Y-%m-%d %H:%M:%S")
          server_info="Server IP: 14.225.205.10\nDirectory: ~/Travel/BE/Tralvel"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="âœ… Dai Dev Try CI/CD Build and Deploy thÃ nh cÃ´ng trÃªn *${{ github.ref_name }}* ðŸš€\n\nDeploy Time: ${deploy_time}\n${server_info}" \
          -d parse_mode=Markdown
